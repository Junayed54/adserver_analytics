
{% extends 'Html/src/html/index.html' %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-xl-12">
        <div class="card custom-card">
            <div class="card-header">
                <div class="card-title">Dashboard Overview</div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                                <div class="card overflow-hidden">
                                    <div class="card-body">
                                        <div class="d-flex align-items-top justify-content-between">
                                            <div>
                                                <p class="mb-1 text-muted">Advertisers</p>
                                                <h2 class="fw-bold mb-0 lh-1" id="total_advertisers">...</h2>
                                            </div>
                                            <div class="ms-auto">
                                                <span class="avatar avatar-md bg-primary-transparent text-primary">
                                                    <i class="ri-user-2-line fs-20"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                                <div class="card overflow-hidden">
                                    <div class="card-body">
                                        <div class="d-flex align-items-top justify-content-between">
                                            <div>
                                                <p class="mb-1 text-muted">Campaigns</p>
                                                <h2 class="fw-bold mb-0 lh-1" id="total_campaigns">...</h2>
                                            </div>
                                            <div class="ms-auto">
                                                <span class="avatar avatar-md bg-success-transparent text-success">
                                                    <i class="ri-megaphone-line fs-20"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                                <div class="card overflow-hidden">
                                    <div class="card-body">
                                        <div class="d-flex align-items-top justify-content-between">
                                            <div>
                                                <p class="mb-1 text-muted">Banners</p>
                                                <h2 class="fw-bold mb-0 lh-1" id="total_banners">...</h2>
                                            </div>
                                            <div class="ms-auto">
                                                <span class="avatar avatar-md bg-info-transparent text-info">
                                                    <i class="ri-image-line fs-20"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                                <div class="card overflow-hidden">
                                    <div class="card-body">
                                        <div class="d-flex align-items-top justify-content-between">
                                            <div>
                                                <p class="mb-1 text-muted">Zones</p>
                                                <h2 class="fw-bold mb-0 lh-1" id="total_zones">...</h2>
                                            </div>
                                            <div class="ms-auto">
                                                <span class="avatar avatar-md bg-warning-transparent text-warning">
                                                    <i class="ri-global-line fs-20"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                                <div class="card overflow-hidden">
                                    <div class="card-body">
                                        <div class="d-flex align-items-top justify-content-between">
                                            <div>
                                                <p class="mb-1 text-muted">Impressions</p>
                                                <h2 class="fw-bold mb-0 lh-1" id="total_impressions">...</h2>
                                            </div>
                                            <div class="ms-auto">
                                                <span class="avatar avatar-md bg-dark-transparent text-dark">
                                                    <i class="ri-eye-line fs-20"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                                <div class="card overflow-hidden">
                                    <div class="card-body">
                                        <div class="d-flex align-items-top justify-content-between">
                                            <div>
                                                <p class="mb-1 text-muted">Clicks</p>
                                                <h2 class="fw-bold mb-0 lh-1" id="total_clicks">...</h2>
                                            </div>
                                            <div class="ms-auto">
                                                <span class="avatar avatar-md bg-danger-transparent text-danger">
                                                    <i class="ri-mouse-line fs-20"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-8 col-lg-6 col-md-12">
                        <div class="card custom-card">
                            <div class="card-header">
                                <div class="card-title">Impressions vs. Clicks</div>
                            </div>
                            <div class="card-body">
                                <canvas id="impressionsClicksChart"></canvas>
                            </div>
                        </div>
                    </div>
                     <div class="col-xl-4 col-lg-6 col-md-6">
                        <div class="card overflow-hidden">
                            <div class="card-body">
                                <div class="d-flex align-items-top justify-content-between">
                                    <div>
                                        <p class="mb-1 text-muted">CTR</p>
                                        <h2 class="fw-bold mb-0 lh-1" id="ctr">...</h2>
                                    </div>
                                    <div class="ms-auto">
                                        <span class="avatar avatar-md bg-secondary-transparent text-secondary">
                                            <i class="ri-percent-line fs-20"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card custom-card mt-4">
            <div class="card-header">
                <div class="card-title">Account Management</div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header">
                                <div class="card-title">Publishers</div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table text-nowrap table-hover">
                                        <thead>
                                            <tr>
                                                <th scope="col">ID</th>
                                                <th scope="col">Name</th>
                                                <th scope="col">Contact Name</th>
                                                <th scope="col">Email</th>
                                                <th scope="col">Username</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="publishers-table-body">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header">
                                <div class="card-title">Advertisers</div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table text-nowrap table-hover">
                                        <thead>
                                            <tr>
                                                <th scope="col">ID</th>
                                                <th scope="col">Name</th>
                                                <th scope="col">Contact Name</th>
                                                <th scope="col">Email</th>
                                                <th scope="col">Username</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="advertisers-table-body">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const publishersTableBody = document.getElementById('publishers-table-body');
    const advertisersTableBody = document.getElementById('advertisers-table-body');

    // Fetch both admin dashboard and accounts data
    fetch('/api/admin-dashboard/')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(adminData => {
            console.log(adminData);
            // Update admin dashboard stats
            document.getElementById('total_advertisers').innerText = adminData.total_advertisers ?? 'N/A';
            document.getElementById('total_campaigns').innerText = adminData.total_campaigns ?? 'N/A';
            document.getElementById('total_banners').innerText = adminData.total_banners ?? 'N/A';
            document.getElementById('total_zones').innerText = adminData.total_zones ?? 'N/A';
            document.getElementById('total_impressions').innerText = (adminData.total_impressions ?? 0).toLocaleString();
            document.getElementById('total_clicks').innerText = (adminData.total_clicks ?? 0).toLocaleString();
            document.getElementById('ctr').innerText = `${adminData.ctr ?? 0}%`;

            // Chart for impressions vs clicks
            const ctx = document.getElementById('impressionsClicksChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Impressions', 'Clicks'],
                    datasets: [{
                        label: 'Impressions & Clicks',
                        data: [adminData.total_impressions, adminData.total_clicks],
                        backgroundColor: ['rgba(54, 162, 235, 0.5)', 'rgba(255, 99, 132, 0.5)'],
                        borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        })
        .catch(error => {
            console.error('Admin dashboard fetch error:', error);
            document.querySelectorAll('#total_advertisers, #total_campaigns, #total_banners, #total_zones, #total_impressions, #total_clicks, #ctr')
                .forEach(el => el.innerText = 'N/A');
        });

    // Fetch accounts list from the same view
    fetch('/api/accounts/')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            function populateTable(accounts, tableBody, dashboardUrlBase) {
                tableBody.innerHTML = '';
                if (!accounts || accounts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No accounts found.</td></tr>';
                    return;
                }
                accounts.forEach(account => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${account.id}</td>
                        <td>${account.name}</td>
                        <td>${account.contact || 'N/A'}</td>
                        <td>${account.email || 'N/A'}</td>
                        <td>${account.account_type || 'N/A'}</td>
                        <td>
                            <a href="${dashboardUrlBase}${account.id}/" class="btn btn-sm btn-primary">View Dashboard</a>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            populateTable(data.publishers, publishersTableBody, '/publisher-dashboard/');
            populateTable(data.advertisers, advertisersTableBody, '/advertiser-dashboard/');
        })
        .catch(error => {
            console.error('Accounts fetch error:', error);
            publishersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load data.</td></tr>';
            advertisersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load data.</td></tr>';
        });
});
</script>

{% endblock %}